<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Test 3: Blob URL Attempt</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .status { padding: 10px; margin: 10px 0; background: #333; }
        .success { background: #2d5a2d; }
        .error { background: #5a2d2d; }
        .warning { background: #5a5a2d; }
    </style>
</head>
<body>
    <h1>Test 3: Blob URL Workaround Attempt</h1>
    <div id="status" class="status">Testing Blob URL approach...</div>
    <pre id="output"></pre>
    
    <script>
        const status = document.getElementById('status');
        const output = document.getElementById('output');
        
        async function testBlobApproach() {
            const logs = [];
            
            try {
                // Step 1: Create a simple worker via Blob URL
                logs.push('1. Creating simple worker via Blob URL...');
                const workerCode = `
                    self.onmessage = function(e) {
                        self.postMessage('Worker received: ' + e.data);
                    };
                `;
                const workerBlob = new Blob([workerCode], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(workerBlob);
                const worker = new Worker(workerUrl);
                
                logs.push('✓ Simple worker created successfully');
                
                // Step 2: Test worker
                worker.onmessage = (e) => {
                    logs.push('✓ Worker communication works: ' + e.data);
                };
                worker.postMessage('Hello');
                
                // Step 3: Try to create a WASM module via Blob
                logs.push('\n2. Creating WASM module via Blob URL...');
                
                // Minimal WASM module (just exports a function that returns 42)
                const wasmBytes = new Uint8Array([
                    0x00, 0x61, 0x73, 0x6d, 0x01, 0x00, 0x00, 0x00,
                    0x01, 0x06, 0x01, 0x60, 0x00, 0x01, 0x7f, 0x03,
                    0x02, 0x01, 0x00, 0x07, 0x08, 0x01, 0x04, 0x74,
                    0x65, 0x73, 0x74, 0x00, 0x00, 0x0a, 0x06, 0x01,
                    0x04, 0x00, 0x41, 0x2a, 0x0b
                ]);
                
                const wasmBlob = new Blob([wasmBytes], { type: 'application/wasm' });
                const wasmUrl = URL.createObjectURL(wasmBlob);
                
                // Try different loading methods
                logs.push('\n3. Testing WASM loading methods:');
                
                // Method 1: Direct instantiation
                try {
                    const wasmModule = await WebAssembly.instantiate(wasmBytes);
                    logs.push('✓ Direct WASM instantiation works');
                    logs.push(`  Result: ${wasmModule.instance.exports.test()}`);
                } catch (e) {
                    logs.push('✗ Direct instantiation failed: ' + e.message);
                }
                
                // Method 2: Fetch from Blob URL
                try {
                    const response = await fetch(wasmUrl);
                    const buffer = await response.arrayBuffer();
                    const wasmModule = await WebAssembly.instantiate(buffer);
                    logs.push('✓ Blob URL WASM loading works');
                } catch (e) {
                    logs.push('✗ Blob URL loading failed: ' + e.message);
                }
                
                logs.push('\n4. DuckDB-specific challenges:');
                logs.push('- DuckDB WASM is ~10MB (too large for inline)');
                logs.push('- Requires SharedArrayBuffer (blocked on file://)');
                logs.push('- Complex worker setup with message passing');
                logs.push('- Module resolution expects real URLs');
                
                status.className = 'status warning';
                status.textContent = 'Tests complete - see results below';
                
            } catch (error) {
                logs.push('\nError: ' + error.message);
                status.className = 'status error';
                status.textContent = 'Test failed';
            }
            
            output.textContent = logs.join('\n');
        }
        
        testBlobApproach();
    </script>
</body>
</html>